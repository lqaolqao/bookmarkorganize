# Project Rules & Constraints

本文件用于约束 AI 在本项目中的所有代码生成、修改和扩展行为。
任何新增或修改代码，必须遵守以下规则。

---

## 一、总体架构规则

1. 本项目为 Serverless 架构
   - 后端运行在 Vercel Serverless Functions
   - 不允许假设存在长期运行的服务器或进程

2. 前后端严格分离
   - 前端：Vue + JavaScript（Vite 构建）
   - 后端：/api 目录下的 Node.js Serverless Functions
   - 不允许在前端实现任何后端逻辑或密钥相关功能

---

## 二、环境变量与密钥规则（强制）

1. 所有密钥必须通过环境变量读取
   - KV_REST_API_URL
   - KV_REST_API_TOKEN
   - AI_API_KEY

2. 禁止以下行为：
   - 在代码中硬编码任何密钥
   - 在前端代码中访问 process.env 中的密钥
   - 使用 VITE_ 前缀暴露任何密钥到前端

3. 后端代码中读取环境变量必须假设：
   - 变量可能未配置
   - 需要进行存在性校验并给出明确错误

---

## 三、KV / 数据存储规则（强制）

1. KV 仅用于存储临时 session 数据
2. 所有写入 KV 的数据必须设置 TTL
   - 默认 TTL = 3600 秒
   - 不允许永久存储用户上传内容
3. KV 的 key 规范：
   - 统一使用：session:<session_id>
   - 禁止任意 key 读写
4. 禁止在 KV 中存储：
   - API Key
   - 用户身份信息
   - 长期业务数据

---

## 四、Session 规则（强制）

1. session_id 必须：
   - 使用随机、不可预测的方式生成（如 UUID）
   - 不基于用户输入
   - 不基于 IP 或 User-Agent

2. session_id 仅作为：
   - 临时访问凭证
   - 查询与下载结果的唯一标识

3. 所有 API 在处理 session_id 时必须：
   - 校验是否存在
   - KV 中不存在即返回 404

---

## 五、后端 API 设计规则

1. API 仅暴露明确的白名单功能
   - 上传
   - 查询状态
   - 获取结果
2. 禁止实现：
   - 任意 KV 读写接口
   - 任意命令执行接口
3. API 必须具备基础防护：
   - 文件大小限制
   - URL 数量限制（如 ≤ 500）
   - 合理的错误返回

---

## 六、AI 使用规则（当前未实现，但必须遵守）

1. AI API 调用只能发生在后端
2. 前端不得直接调用任何 AI 服务
3. AI 调用必须：
   - 可控（分批、限量）
   - 可失败（允许降级）
4. AI 输出必须转换为明确的结构化结果
   - 禁止直接信任原始自然语言输出

---

## 七、代码演进规则

1. 新功能应优先：
   - 扩展 lib/ 目录中的模块
   - 而不是修改 API 接口契约
2. 分类逻辑的变更应集中在：
   - lib/classify.js
3. KV 实现细节的变更应集中在：
   - lib/kv.js
4. 不允许为了新增功能而破坏：
   - TTL 机制
   - session 机制
   - 密钥隔离机制

---

## 八、安全与隐私原则（设计级）

1. 用户上传的数据为短期、临时数据
2. 所有数据在 TTL 到期后自动删除
3. 系统不承诺长期保存用户数据
4. 即使 session_id 泄露，影响范围也必须受 TTL 限制

---

## 九、禁止事项（红线）

- 禁止在前端存储或打印任何密钥
- 禁止去掉 KV TTL
- 禁止将 session_id 设计为可预测值
- 禁止引入登录系统作为“临时访问控制”的替代方案
